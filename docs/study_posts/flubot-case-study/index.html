<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   <meta name="description" content="RADER Roman, JEŘÁBEK Kamil and RYŠAVÝ Ondřej. Detecting DoH-Based Data Exfiltration: FluBot Malware Case Study. In: IEEE 48th Conference on Local Computer Networks (LCN). Daytona Beach: IEEE Computer Society, 2023, pp. 50-54. ISBN 979-8-3503-0074-1.
Attendance at the 48th IEEE Conference on Local Computer Networks Our paper on Detecting DoH-based data exfiltration was published at the 48th IEEE Conference on Local Computer Networks, which took place from October 1-5, 2023, in Daytona Beach, Florida, USA.">  

  <title>
    
      [The 49th IEEE LCN Conference] Detecting DoH-Based Data Exfiltration: FluBot Malware Case Study
    
  </title>


  <link rel="shortcut icon" type="image/x-icon" href="/" />
  
  
  
  <link rel="stylesheet" href="/css/main.ebe15b0394daa6798b8a40aa572a71b5a7a1beb8cc02c392f5c142e7d08ddb6052e049639385106440b538f394884685082b7441eef27a6a8315ec723155dc15.css" integrity="sha512-6&#43;FbA5TapnmLikCqVypxtaehvrjMAsOS9cFC59CN22BS4Eljk4UQZEC1OPOUiEaFCCt0Qe7yemqDFexyMVXcFQ==" />
   <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
      document.querySelectorAll("mjx-container").forEach(function(x){
        x.parentElement.classList += 'has-jax'})
    });

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
 
</head>
<body a="auto">
        <main class="page-content" aria-label="Content">
            <div class="w">
<a href="/">..</a>

<article>
    <p class="post-meta">
        <time datetime="2023-09-26 11:47:10 &#43;0300 EEST">
            2023-09-26
        </time>
    </p>

    <h1>[The 49th IEEE LCN Conference] Detecting DoH-Based Data Exfiltration: FluBot Malware Case Study</h1>

    <p>RADER Roman, JEŘÁBEK Kamil and RYŠAVÝ Ondřej. Detecting DoH-Based Data Exfiltration: FluBot Malware Case Study. In: IEEE 48th Conference on Local Computer Networks (LCN). Daytona Beach: IEEE Computer Society, 2023, pp. 50-54. ISBN 979-8-3503-0074-1.</p>
<h1 id="attendance-at-the-48th-ieee-conference-on-local-computer-networks">Attendance at the 48th IEEE Conference on Local Computer Networks</h1>
<p><img src="/flubot/lcn2023_banner.png" alt="Conference Banner"></p>
<p>Our paper on Detecting DoH-based data exfiltration was published at the 48th IEEE Conference on <a href="https://www.ieeelcn.org/index.html">Local Computer Networks</a>, which took place from October 1-5, 2023, in Daytona Beach, Florida, USA. Paper is authored by Roman Rader, Kamil Jerabek, Ondrej Rysavy.</p>
<h2 id="introduction">Introduction</h2>
<p>Paper describes a case-study on detecting the FluBot, an Android banking Trojan active in 2021-2022. Prior work on DoH malware detection has focused on machine learning classifiers to detect malware flows within DoH traffic. Our paper introduces a two-layer detection method.</p>
<h2 id="two-layered-doh-malware-detection">Two-Layered DoH Malware Detection</h2>
<p>This approach allows the same malware detection algorithm to be used for different encrypted DNS protocols (e.g., DNS-over-TLS, DoQ) by <strong>plugging in different classifiers to the first layer</strong>.</p>
<p>Also, now we can apply malware-detection algorithms originally designed for the plaintext DNS to the DoH traffic <strong>by plugging in detection algorithms to the second layer</strong>.</p>
<p><img src="/flubot/two-layers-rev.drawio.png" alt="Two layers">
Application of Plaintext DNS malware detection algorithm to the encrypted DNS using DoH classification model.</p>
<h2 id="algorithm-details">Algorithm Details</h2>
<ul>
<li><strong>Layer 1</strong>: Model for DNS-over-HTTPS detection was trained on the extensive DoH traffic dataset [1]. Layer 1 allows us to use previously developed plaintext DNS-based malware-detection algorithms to the encrypted DNS traffic.</li>
<li><strong>Layer 2</strong>: We used a modified method by [2] which uses a ratio of DNS requests and contacted IP addresses for each host in the local network to detect anomaly malicious activity: $\ln~\rho(a)~=~\ln {\frac{\delta(a)}{\pi(a) + 1}}$. $\delta(a)$ - number of DNS requests generated by host $a$, $\pi(a)$ - count of unique IP addresses contacted by host $a$. However, a two-layered approach allows to plug in any other plaintext DNS malware detection method.</li>
</ul>
<h2 id="doh-detection-tweaks">DoH Detection Tweaks</h2>
<ul>
<li>
<p>Random Forest model proved to be the best comparing to Histogram-based Gradient Boosting and Logistic Regression. <strong>Features:</strong> stddev, mean, variance from packet sizes and inter-packet times grouped by: incoming, outgoing, and combined packets.</p>
</li>
<li>
<p>To enhance accuracy of DoH flows detection, we reduce the impact of initial TLS handshake packets, which often reflect server deployment rather than actual traffic. As seen on the figure, <strong>we have applied weights to the first few packets based on their position</strong> in the handshake sequence to account for TLS handshake varying length and ensure that no important information is lost.</p>
</li>
</ul>
<p><img src="/flubot/elimination.drawio.png" alt="Elimination of TLS">
TLS Handshake influence elimination by applying lower weights to~the~first N, M &lt;= 6 packets.</p>
<h2 id="experimental-setup">Experimental Setup</h2>
<p>We created a sandbox network of three Android x86 emulators and one Linux instance to simulate the malware detection method. We connected these machines via an OpenWRT router with <strong>ipfixprobe tool</strong> to collect IPFIX flows to capture network traffic at the border.</p>
<p><img src="/flubot/network.dio.drawio.png" alt="Network">
Sandbox network used to collect FluBot malware traffic, as well as benign traffic from other Android devices.</p>
<h2 id="results-of-two-experiments">Results of Two Experiments</h2>
<ul>
<li>
<p>In Experiment 1 (Clean Room), one Android VM was infected with malware, while two others stayed clean. We scripted the clean VMs to browse benign websites. $\ln \rho(a)$ was calculated for all machines to validate malware detection algorithm.</p>
</li>
<li>
<p>In Experiment 2 (Real-World Scenario), we infected one Android VM with malware and scripted it to generate benign traffic at the same time <strong>to test our method&rsquo;s ability to detect the infected machine amidst normal browsing interference</strong>. We have applied an ARIMA-based outlier detection using confidence intervals based on the user&rsquo;s typical behavior (see figure).</p>
</li>
</ul>
<p><img src="/flubot/fig-real-world-flubot-detection-1-output-2.png" alt="Results ARIMA">
The moment of infection of an Android with FluBot. The value of~$\ln \rho(a)$ rises above the confidence interval after infection -&gt; IoC.</p>
<h2 id="conclusions">Conclusions</h2>
<p>We introduced a two-layer classification method to detect FluBot malware exploiting DoH covert channels. Future research will focus on enhancing detection accuracy and extending the model to other DNS-based covert channels like DoH, DoT, and DoQ.</p>
<hr>
<ul>
<li><a href="https://rrader.github.io/doh-flubot-detection/">Experimental jupyter notebooks</a></li>
<li>DOI <a href="https://doi.org/10.1109/LCN58197.2023.10223341">10.1109/LCN58197.2023.10223341</a></li>
<li>Citation:</li>
</ul>
<pre tabindex="0"><code>@INPROCEEDINGS{10223341,
  author={Rader, Roman and Jerabek, Kamil and Rysavy, Ondrej},
  booktitle={2023 IEEE 48th Conference on Local Computer Networks (LCN)}, 
  title={Detecting DoH-Based Data Exfiltration: FluBot Malware Case Study}, 
  year={2023},
  volume={},
  number={},
  pages={1-4},
  abstract={This paper presents a novel approach for detecting the FluBot malware, an advanced Android banking Trojan that has been observed in active attacks in 2021 and 2022. The proposed method uses a two-layer detection mechanism to identify FluBot network connections. In the first layer, a machine learning algorithm is used to detect DNS-over-HTTPS (DoH) within Netflow records. The second layer uses a modified version of an existing domain generation algorithm (DGA) detection algorithm to target the DoH connections associated with the FluBot malware specifically. To evaluate the effectiveness of this approach, we used a dataset consisting of FluBot network traffic captured in a controlled sandbox environment. The preliminary results show that our DoH classifier achieves high accuracy and detection rates in identifying instances of FluBot malware, while maintaining a low false positive rate.},
  keywords={},
  doi={10.1109/LCN58197.2023.10223341},
  ISSN={2832-1421},
  month={Oct},}
</code></pre><hr>
<p>References:</p>
<ul>
<li>[1] K. Jeřábek, K. Hynek, T. Čejka, and O. Ryšavỳ, “Collection of datasets with dns over https traffic,” Data in Brief, vol. 42, p. 108310, 2022.</li>
<li>[2] M. Grill, I. Nikolaev, V. Valeros, and M. Rehak, “Detecting dga malware using netflow,” in
2015 IFIP/IEEE International Symposium on Integrated Network Management (IM),
pp. 1304–1309, IEEE, 2015.</li>
<li>[3] H. Salsabila, S. Mardhiyah, and R. B. Hadiprakoso, “Flubot malware hybrid analysis on
android operating system,” in 2022 International Conference on Informatics, Multimedia, Cyber
and Information System (ICIMCIS), pp. 202–206, IEEE, 2022.</li>
</ul>
<p>This work was supported by the Technology Agency of the Czech Republic as part of the
FW03010099 project: Context-based analysis of encrypted traffic using flow data.</p>

</article>

            </div>
        </main>
    </body>
</html>
